# 组合装生成工具 - 使用说明

## 📖 项目简介

本项目是基于 SoybeanAdmin 的前后端分离系统，专门用于商品组合装的生成和管理。系统采用现代化的技术架构，包含：

- **前端**：Vue 3 + Vite + TypeScript + Naive UI（原有的 SoybeanAdmin）
- **后端**：Python FastAPI + SQLAlchemy（新增）
- **数据库**：MySQL 8.0（持久化存储）
- **缓存**：Redis 7（性能优化）
- **部署**：Docker + Docker Compose（容器化）

## 🚀 快速开始

### 一键启动（最简单）

```bash
# 1. 克隆项目
git clone <仓库地址>
cd <项目目录>

# 2. 切换到功能分支
git checkout feat-split-front-back-python-docker-mysql-redis

# 3. 运行自动化脚本
chmod +x scripts/setup.sh
./scripts/setup.sh

# 4. 访问系统
# 前端：http://localhost
# API文档：http://localhost/docs
# 健康检查：http://localhost/api/health
```

### 使用 Docker Compose

```bash
# 启动所有服务（生产模式）
docker-compose up -d

# 或启动开发模式（带热重载）
docker-compose -f docker-compose.dev.yml up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 迁移模板数据
docker-compose exec backend python /app/../scripts/migrate_templates.py /app/../tool/templates.json
```

## 📚 核心功能

### 1. 模板管理

**查看所有模板：**
```bash
curl http://localhost/api/v1/templates
```

**创建新模板：**
```bash
curl -X POST http://localhost/api/v1/templates \
  -H "Content-Type: application/json" \
  -d '{
    "name": "新模板",
    "description": "模板描述",
    "combos": [
      {
        "prefix": "TEST_",
        "items": [
          {
            "product_code": "PROD001",
            "quantity": 1,
            "sale_price": 100.0,
            "base_price": 90.0,
            "cost_price": 50.0
          }
        ]
      }
    ]
  }'
```

**更新模板：**
```bash
curl -X PUT http://localhost/api/v1/templates/1 \
  -H "Content-Type: application/json" \
  -d '{"name": "更新后的名称"}'
```

**删除模板：**
```bash
curl -X DELETE http://localhost/api/v1/templates/1
```

### 2. 生成组合装

```bash
curl -X POST http://localhost/api/v1/combos/generate \
  -H "Content-Type: application/json" \
  -d '{
    "template_id": 1,
    "main_product_codes": ["M001", "M002"],
    "main_product_specs": ["深蓝色-L", "深蓝色-M"],
    "main_product_quantities": [1, 1],
    "main_product_sale_prices": [100.0, 100.0],
    "main_product_base_prices": [90.0, 90.0],
    "main_product_cost_prices": [50.0, 50.0]
  }'
```

### 3. 健康检查

```bash
# 完整健康检查（包含数据库和Redis状态）
curl http://localhost/api/health

# 快速Ping
curl http://localhost/api/health/ping
```

## 🛠️ 常用命令

### Docker 管理

```bash
# 启动服务
docker-compose up -d

# 停止服务
docker-compose down

# 重启服务
docker-compose restart backend

# 查看日志
docker-compose logs -f backend
docker-compose logs -f mysql
docker-compose logs -f redis

# 进入容器
docker-compose exec backend bash
docker-compose exec mysql mysql -u combo_user -pcombo_password combo_db
docker-compose exec redis redis-cli
```

### 数据库操作

```bash
# 连接MySQL
docker-compose exec mysql mysql -u combo_user -pcombo_password combo_db

# 查看所有表
docker-compose exec mysql mysql -u combo_user -pcombo_password combo_db -e "SHOW TABLES;"

# 查看模板数量
docker-compose exec mysql mysql -u combo_user -pcombo_password combo_db -e "SELECT COUNT(*) FROM templates;"

# 备份数据库
docker-compose exec mysql mysqldump -u combo_user -pcombo_password combo_db > backup_$(date +%Y%m%d).sql

# 恢复数据库
docker-compose exec -T mysql mysql -u combo_user -pcombo_password combo_db < backup.sql
```

### Redis 操作

```bash
# 连接Redis
docker-compose exec redis redis-cli

# 查看所有缓存键
docker-compose exec redis redis-cli KEYS '*'

# 查看特定键的值
docker-compose exec redis redis-cli GET template:1

# 清空所有缓存
docker-compose exec redis redis-cli FLUSHDB

# 查看Redis信息
docker-compose exec redis redis-cli INFO
```

## 📋 服务端口

### 生产环境 (docker-compose.yml)
- 前端 Nginx: 80, 443
- 后端 API: 8000
- MySQL: 3306
- Redis: 6379

### 开发环境 (docker-compose.dev.yml)
- 后端 API: 8000
- MySQL: 3307
- Redis: 6380

## 🔧 配置说明

### 环境变量配置

编辑 `backend/.env` 文件：

```env
# 应用配置
APP_NAME=Combo Tool API
DEBUG=false
ENVIRONMENT=production

# 数据库配置
DATABASE_URL=mysql+pymysql://combo_user:combo_password@mysql:3306/combo_db
DATABASE_POOL_SIZE=20

# Redis配置
REDIS_URL=redis://redis:6379/0
CACHE_TTL=3600

# 安全配置
SECRET_KEY=your-secret-key-change-in-production

# CORS配置
CORS_ORIGINS=http://localhost:3000,http://localhost:5173
```

### MySQL 配置

在 `docker-compose.yml` 中修改：

```yaml
mysql:
  environment:
    MYSQL_ROOT_PASSWORD: 你的root密码
    MYSQL_DATABASE: combo_db
    MYSQL_USER: combo_user
    MYSQL_PASSWORD: 你的密码
```

## 🐛 常见问题

### 1. 后端无法启动

**原因**：数据库未就绪或配置错误

**解决方案**：
```bash
# 查看后端日志
docker-compose logs backend

# 检查MySQL是否就绪
docker-compose logs mysql | grep "ready for connections"

# 重启后端
docker-compose restart backend
```

### 2. 数据库连接失败

**原因**：MySQL服务未启动或密码错误

**解决方案**：
```bash
# 检查MySQL状态
docker-compose ps mysql

# 测试连接
docker-compose exec mysql mysqladmin ping -h localhost -u combo_user -pcombo_password

# 重启MySQL
docker-compose restart mysql
```

### 3. Redis连接失败

**原因**：Redis服务未启动

**解决方案**：
```bash
# 检查Redis状态
docker-compose ps redis

# 测试连接
docker-compose exec redis redis-cli ping

# 重启Redis
docker-compose restart redis
```

### 4. 端口被占用

**原因**：本地已有服务占用端口

**解决方案**：
```bash
# 查看端口占用
lsof -i :8000  # 后端
lsof -i :3306  # MySQL
lsof -i :6379  # Redis

# 停止占用端口的进程
kill -9 <进程ID>

# 或者修改 docker-compose.yml 中的端口映射
```

### 5. 数据迁移失败

**原因**：JSON文件路径错误或数据库未就绪

**解决方案**：
```bash
# 确保JSON文件存在
ls -la tool/templates.json

# 手动运行迁移
docker-compose exec backend python /app/../scripts/migrate_templates.py /app/../tool/templates.json

# 查看迁移日志
docker-compose logs backend | grep migrate
```

### 6. 前端无法访问

**原因**：Nginx配置错误或dist目录不存在

**解决方案**：
```bash
# 构建前端
pnpm install
pnpm run build

# 检查dist目录
ls -la dist/

# 重启frontend服务
docker-compose restart frontend
```

## 📖 详细文档

- **[README.md](README.md)** - 项目主文档，包含快速开始指南
- **[QUICK_START.md](QUICK_START.md)** - 详细的快速入门和故障排除
- **[DEPLOYMENT.md](DEPLOYMENT.md)** - 完整的部署指南和运维手册
- **[ARCHITECTURE.md](ARCHITECTURE.md)** - 系统架构设计和技术选型
- **[PROJECT_SUMMARY.md](PROJECT_SUMMARY.md)** - 项目改造完整总结
- **[CHANGES.md](CHANGES.md)** - 详细的变更记录
- **[backend/README.md](backend/README.md)** - 后端API开发文档

## 🌐 在线文档

启动服务后，访问以下地址查看在线文档：

- **Swagger UI**: http://localhost/docs - 交互式API文档
- **ReDoc**: http://localhost/redoc - 另一种API文档风格
- **OpenAPI**: http://localhost/openapi.json - API规范定义

## 💡 最佳实践

### 开发流程

1. **启动开发环境**
   ```bash
   docker-compose -f docker-compose.dev.yml up -d
   ```

2. **查看实时日志**
   ```bash
   docker-compose -f docker-compose.dev.yml logs -f backend
   ```

3. **修改代码**
   - 后端代码修改后会自动重载
   - 前端使用 `pnpm dev` 开发

4. **测试API**
   - 访问 http://localhost/docs 测试接口
   - 使用 curl 或 Postman 测试

5. **提交代码**
   ```bash
   git add .
   git commit -m "feat: 添加新功能"
   git push
   ```

### 生产部署

1. **配置环境变量**
   ```bash
   cp backend/.env.example backend/.env
   # 编辑 .env，设置强密码和生产配置
   ```

2. **构建镜像**
   ```bash
   docker-compose build
   ```

3. **启动服务**
   ```bash
   docker-compose up -d
   ```

4. **健康检查**
   ```bash
   curl http://localhost/api/health
   ```

5. **数据备份**
   ```bash
   # 设置定时备份
   0 2 * * * docker-compose exec mysql mysqldump -u combo_user -pcombo_password combo_db > /backup/combo_db_$(date +\%Y\%m\%d).sql
   ```

## 🔐 安全建议

1. **修改默认密码**
   - MySQL root密码
   - MySQL用户密码
   - SECRET_KEY

2. **限制端口访问**
   - 生产环境不要暴露MySQL和Redis端口
   - 使用防火墙限制访问

3. **启用HTTPS**
   - 配置SSL证书
   - 使用Let's Encrypt免费证书

4. **定期更新**
   - 更新Docker镜像
   - 更新依赖包
   - 定期备份数据

## 📞 获取帮助

如果遇到问题：

1. 查看日志：`docker-compose logs -f`
2. 检查健康状态：`docker-compose ps`
3. 访问API文档：http://localhost/docs
4. 查看详细文档：[QUICK_START.md](QUICK_START.md)
5. 提交Issue：[GitHub Issues](https://github.com/your-repo/issues)

## 🎉 总结

本系统提供了完整的前后端分离解决方案，具有以下优势：

- ✅ **易于部署**：Docker一键启动
- ✅ **高性能**：Redis缓存 + 数据库连接池
- ✅ **易于维护**：清晰的代码结构和完善的文档
- ✅ **可扩展**：模块化设计，易于添加新功能
- ✅ **生产就绪**：完整的监控和日志系统

祝使用愉快！🚀
